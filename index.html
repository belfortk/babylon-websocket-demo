<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>Babylon - Getting Started</title>
    <!--- Link to the last version of BabylonJS --->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        #renderCanvas {
            width   : 50%;
            height  : 50%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <h1>Upload Model</h1>
    <ul id="model"></ul>
    <input type="file" name="model" id="model-input">
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      $('#model-input').change(function(e){
        e.preventDefault(); // prevents page reloading
        const file = e.target.files[0];
        console.log(file)
        const fileData = {
          name: file.name,
          data: file
        }
        socket.emit('file uploaded', fileData);
        return false;
      });
        window.addEventListener('DOMContentLoaded', function(){
            // get the canvas DOM element
            var canvas = document.getElementById('renderCanvas');

            // load the 3D engine
            var engine = new BABYLON.Engine(canvas, true);

            // createScene function that creates and return the scene
            var createScene = function(){
                // create a basic BJS Scene object
                var scene = new BABYLON.Scene(engine);

                // create a FreeCamera, and set its position to (x:0, y:5, z:-10)
                var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 5,-10), scene);

                // target the camera to scene origin
                camera.setTarget(BABYLON.Vector3.Zero());

                // attach the camera to the canvas
                camera.attachControl(canvas, false);

                // create a basic light, aiming 0,1,0 - meaning, to the sky
                var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);

                // create a built-in "sphere" shape; its constructor takes 6 params: name, segment, diameter, scene, updatable, sideOrientation 
                var sphere = BABYLON.Mesh.CreateSphere('sphere1', 16, 2, scene);

                // move the sphere upward 1/2 of its height
                sphere.position.y = 1;

                // create a built-in "ground" shape;
                var ground = BABYLON.Mesh.CreateGround('ground1', 6, 6, 2, scene);

                // return the created scene
                return scene;
            }

            // call the createScene function
            var scene = createScene();

            // run the render loop
            engine.runRenderLoop(function(){
                scene.render();
            });

            // the canvas/window resize event handler
            window.addEventListener('resize', function(){
                engine.resize();
            });

            // not passing any url since it defaults to trying to connect
          // to the host that serves the page.  
          socket.on('file uploaded', function(filedata){
            console.log(filedata);
            $('#model').append($('<li>').text(filedata.name));
            var blob = new Blob([filedata.data]);
            var url = URL.createObjectURL(blob);
            console.log(url);
            BABYLON.SceneLoader.Append("", url, scene, function () { 
              scene.createDefaultCamera(true, true, true);
              }, undefined, undefined, ".glb");
            });
          });
    </script>
    <script>
      $(function () {
        // // not passing any url since it defaults to trying to connect
        // // to the host that serves the page.  
        // var socket = io();
        // $('#model-input').change(function(e){
        //   e.preventDefault(); // prevents page reloading
        //   const file = e.target.files[0];
        //   console.log(file)
        //   const fileData = {
        //     name: file.name,
        //     data: file
        //   }
        //   socket.emit('file uploaded', fileData);
        //   return false;
        // });
        // socket.on('file uploaded', function(filedata){
        //   console.log(filedata);
        //   $('#model').append($('<li>').text(filedata.name));
        //   var blob = new Blob([filedata.data]);
        //   var url = URL.createObjectURL(blob);
        //   console.log(url);
        //   BABYLON.SceneLoader.Append("", url, scene, function () { 
        //     scene.createDefaultCamera(true, true, true);
        //   }, undefined, undefined, ".obj");
        // });
      });
    </script>
</body>
</html>